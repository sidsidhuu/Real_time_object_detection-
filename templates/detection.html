<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Detection</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script>
    let lastPayload = "";
    let isFetching = false;

    function renderDetections(items) {
      const container = document.getElementById("detections");
      if (!items.length) {
        container.innerHTML = "<p class=\"muted\">No detections yet.</p>";
        return;
      }

      const html = items.map(d => (
        `<div class=\"detection-item\">` +
          `<div class=\"detection-title\">${d.index}. ${d.class_name}</div>` +
          `<div class=\"detection-meta\">Confidence: ${d.confidence}%</div>` +
          `<div class=\"detection-meta\">Time: ${d.timestamp}</div>` +
        `</div>`
      )).join("");

      container.innerHTML = html;
    }

    async function loadDetections() {
      if (document.hidden || isFetching) {
        return;
      }
      isFetching = true;
      try {
        const res = await fetch("/detections", { cache: "no-store" });
        const data = await res.json();
        const payload = JSON.stringify(data.detections || []);
        if (payload !== lastPayload) {
          lastPayload = payload;
          renderDetections(data.detections || []);
        }
      } catch (err) {
        console.error("Failed to fetch detections", err);
      } finally {
        isFetching = false;
      }
    }

    window.addEventListener("load", () => {
      loadDetections();
      setInterval(loadDetections, 1200);
    });
  </script>
</head>
<body>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <main class="page">
    <section class="panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">Live session</p>
          <h1>Detection feed</h1>
          <p class="muted">Session: {{ session_name }}</p>
        </div>
        <span class="badge">Active</span>
      </div>

      <div class="layout">
        <div class="video">
          <img src="{{ url_for('video_feed') }}" alt="Live Feed" />
        </div>

        <aside class="sidebar">
          <h2>Detected objects</h2>
          <div id="detections" class="scroll-box">Loading...</div>

          <div class="stack">
            <form action="/stop" method="POST">
              <button class="btn danger" type="submit">Stop detection</button>
            </form>

            <form action="/snapshots" method="GET">
              <input type="hidden" name="session" value="{{ session_name }}">
              <button class="btn primary" type="submit">View snapshots</button>
            </form>

            <form action="/exit" method="POST">
              <button class="btn ghost" type="submit">Exit</button>
            </form>
          </div>
        </aside>
      </div>
    </section>
  </main>
</body>
</html>
